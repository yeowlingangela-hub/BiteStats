
<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>BiteStats</title>
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=Playfair+Display:wght@700&family=Lora:wght@400&display=swap" rel="stylesheet">
    <style>
        :root {
            --bg-image-light: url('https://images.pexels.com/photos/1267320/pexels-photo-1267320.jpeg?auto=compress&cs=tinysrgb&w=1260&h=750&dpr=2');
            --bg-image-dark: url('https://images.pexels.com/photos/1893555/pexels-photo-1893555.jpeg?auto=compress&cs=tinysrgb&w=1260&h=750&dpr=2');
            --bg-color: #333;
            --text-color: #3D2B1F; /* Darker Brown for light mode */
            --logo-text-color: #4A2C2A;
            --card-bg: rgba(255, 255, 255, 0.1);
            --card-border: rgba(255, 255, 255, 0.2);
            --input-bg: rgba(255, 255, 255, 0.8);
            --input-text: #3D2B1F;
            --input-border: rgba(61, 43, 31, 0.5);
            --fork-color: #FF8C00;
            --calories-color: #FF6347;
            --protein-color: #4682B4;
        }

        body {
            margin: 0;
            font-family: 'Lora', serif;
            background-color: var(--bg-color);
            background-image: var(--bg-image-light);
            background-size: cover;
            background-position: center;
            background-attachment: fixed;
            color: var(--text-color);
            display: flex;
            flex-direction: column;
            align-items: center;
            justify-content: center;
            min-height: 100vh;
            padding: 2rem;
            transition: background-image 0.5s ease-in-out;
        }

        body.dark-mode {
            background-image: var(--bg-image-dark);
            --text-color: #FFFFFF;
            --logo-text-color: #FFFFFF;
            --card-bg: rgba(0, 0, 0, 0.6);
            --input-bg: rgba(0, 0, 0, 0.6);
            --input-text: #E0E0E0;
            --input-border: rgba(255, 255, 255, 0.2);
        }
        
        .header-controls {
            position: absolute;
            top: 20px;
            right: 20px;
            display: flex;
            gap: 15px;
            align-items: center;
        }

        #languageSelector, #theme-toggle-button {
            background: rgba(0,0,0,0.5);
            color: white;
            border: 1px solid white;
            padding: 8px 12px;
            border-radius: 20px;
            cursor: pointer;
            -webkit-appearance: none;
            -moz-appearance: none;
            appearance: none;
            padding-right: 30px; 
            background-image: url("data:image/svg+xml;utf8,<svg fill='white' height='24' viewBox='0 0 24 24' width='24' xmlns='http://www.w3.org/2000/svg'><path d='M7 10l5 5 5-5z'/></svg>");
            background-repeat: no-repeat;
            background-position-x: calc(100% - 10px);
            background-position-y: 50%;
        }

        .container {
            text-align: center;
            width: 100%;
            max-width: 600px;
        }

        .logo {
            font-family: 'Playfair Display', serif;
            color: var(--logo-text-color);
            font-size: 5rem;
            font-weight: 700;
            text-shadow: 0 2px 4px rgba(0,0,0,0.5), 0 5px 15px rgba(0,0,0,0.3);
            margin-bottom: 2rem;
        }

        .logo .fork {
            display: inline-block;
            transform: rotate(180deg);
            margin-right: -20px;
            color: var(--fork-color);
            text-shadow: none;
        }

        .search-form {
            margin: 2rem 0;
            display: flex;
            justify-content: center;
            gap: 10px;
        }

        .search-input, .portion-input, #voiceSearchBtn {
            padding: 1rem 1.5rem;
            border-radius: 50px;
            font-size: 1.1rem;
            font-family: 'Lora', serif;
            outline: none;
            text-align: center;
            transition: all 0.3s ease;
            background: var(--input-bg);
            color: var(--input-text);
            border: 1px solid var(--input-border);
            box-shadow: 0 2px 10px rgba(0,0,0,0.1);
        }

        .search-input {
            width: 70%;
        }

        .portion-input {
            width: 25%;
        }

        #voiceSearchBtn {
            width: 50px;
            height: 50px;
            padding: 0;
            border-radius: 50%;
            cursor: pointer;
            font-size: 1.5rem;
        }

        .search-input::placeholder, .portion-input::placeholder {
            color: var(--input-text);
            opacity: 0.7;
        }

        .pulse-animation {
            display: none;
            font-size: 1.2rem;
            animation: pulse 1.5s infinite ease-in-out;
        }

        @keyframes pulse {
            0% { transform: scale(1); opacity: 1; }
            50% { transform: scale(1.05); opacity: 0.8; }
            100% { transform: scale(1); opacity: 1; }
        }

        .results-card {
            background: var(--card-bg);
            backdrop-filter: blur(25px);
            -webkit-backdrop-filter: blur(25px);
            border-radius: 25px;
            padding: 2.5rem;
            margin-top: 2rem;
            box-shadow: 0 15px 40px rgba(0, 0, 0, 0.4);
            border: 1px solid var(--card-border);
            display: none; 
            transform: scale(0.95);
            opacity: 0;
            transition: transform 0.4s ease-out, opacity 0.4s ease-out;
        }
        
        .results-card.visible {
            display: block;
            transform: scale(1);
            opacity: 1;
        }

        .results-content {
            color: var(--text-color);
            text-shadow: 0 1px 3px rgba(0,0,0,0.2);
        }

        .nutrition-item .value {
            font-size: 4rem;
            font-weight: 700;
            margin-top: 0.5rem;
        }

        .calories {
            color: var(--calories-color);
            text-shadow: 0 0 20px var(--calories-color), 0 0 10px #FFFFFF;
        }

        .protein {
            color: var(--protein-color);
            text-shadow: 0 0 20px var(--protein-color), 0 0 10px #FFFFFF;
        }
    </style>
</head>
<body>
    <div class="header-controls">
        <select id="languageSelector"></select>
        <button id="theme-toggle-button" data-key="toggle_theme"></button>
    </div>

    <div class="container">
        <div class="logo">
            Bite<span class="fork">üç¥</span>Stats
        </div>
        <div class="search-form">
            <input type="text" class="search-input" id="searchInput" data-key="search_placeholder">
            <button id="voiceSearchBtn">üé§</button>
            <input type="number" class="portion-input" id="portionInput" data-key="portion_placeholder">
        </div>

        <div class="pulse-animation" id="pulseAnimation" data-key="searching"></div>

        <div class="results-card" id="resultsCard">
            <div class="results-content">
                <h2 id="foodQuery"></h2>
                <div class="verified-badge" id="verifiedBadge" data-key="verified_source"></div>
                <div class="nutrition-info">
                    <div class="nutrition-item">
                        <p data-key="calories_label"></p>
                        <p class="value calories" id="caloriesValue">--</p>
                    </div>
                    <div class="nutrition-item">
                        <p data-key="protein_label"></p>
                        <p class="value protein" id="proteinValue">--</p>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <script>
        const translations = {
            en: { 
                search_placeholder: "e.g., 'sourdough bread' or 'eggs'", 
                portion_placeholder: "Portion", 
                searching: "Searching...", 
                verified_source: "‚úî Verified Source", 
                calories_label: "Estimated Calories", 
                protein_label: "Estimated Protein",
                toggle_theme: "Toggle Theme"
            },
            CN: { 
                search_placeholder: "‰æãÂ¶ÇÔºö'ÈÖ∏Èù¢ÂåÖ'Êàñ'È∏°Ëõã'", 
                portion_placeholder: "‰ªΩÈáè", 
                searching: "Ê≠£Âú®ÊêúÁ¥¢...", 
                verified_source: "‚úî È™åËØÅÊù•Ê∫ê", 
                calories_label: "‰º∞ËÆ°Âç°Ë∑ØÈáå", 
                protein_label: "‰º∞ËÆ°ËõãÁôΩË¥®",
                toggle_theme: "ÂàáÊç¢‰∏ªÈ¢ò"
            },
            fr: { 
                search_placeholder: "Ex: 'pain au levain' ou '≈ìufs'", 
                portion_placeholder: "Portion", 
                searching: "Recherche...", 
                verified_source: "‚úî Source V√©rifi√©e", 
                calories_label: "Calories Estim√©es", 
                protein_label: "Prot√©ines Estim√©es",
                toggle_theme: "Changer de th√®me"
            },
            ms: { 
                search_placeholder: "Cth: 'roti masam' atau 'telur'", 
                portion_placeholder: "Bahagian", 
                searching: "Mencari...", 
                verified_source: "‚úî Sumber Disahkan", 
                calories_label: "Anggaran Kalori", 
                protein_label: "Anggaran Protein",
                toggle_theme: "Tukar Tema"
            },
        };

        const setLanguage = (lang) => {
            document.querySelectorAll("[data-key]").forEach(elem => {
                const key = elem.getAttribute("data-key");
                if (translations[lang] && translations[lang][key]) {
                    if (elem.tagName === 'INPUT') {
                        elem.placeholder = translations[lang][key];
                    } else {
                        elem.textContent = translations[lang][key];
                    }
                }
            });
            localStorage.setItem('language', lang);
        };

        const langSelector = document.getElementById('languageSelector');
        Object.keys(translations).forEach(lang => {
            const option = document.createElement('option');
            option.value = lang;
            option.textContent = lang.toUpperCase();
            langSelector.appendChild(option);
        });

        langSelector.addEventListener('change', (e) => setLanguage(e.target.value));

        const savedLang = localStorage.getItem('language') || 'en';
        langSelector.value = savedLang;
        setLanguage(savedLang);

        const themeToggleButton = document.getElementById('theme-toggle-button');
        const body = document.body;

        const applyTheme = (theme) => {
            if (theme === 'dark') {
                body.classList.add('dark-mode');
            } else {
                body.classList.remove('dark-mode');
            }
            localStorage.setItem('theme', theme);
        }

        themeToggleButton.addEventListener('click', () => {
            const newTheme = body.classList.contains('dark-mode') ? 'light' : 'dark';
            applyTheme(newTheme);
        });
        
        const savedTheme = localStorage.getItem('theme') || 'light';
        applyTheme(savedTheme);
        
        const searchInput = document.getElementById('searchInput');
        const portionInput = document.getElementById('portionInput');
        const pulseAnimation = document.getElementById('pulseAnimation');
        const resultsCard = document.getElementById('resultsCard');
        const foodQuery = document.getElementById('foodQuery');
        const caloriesValue = document.getElementById('caloriesValue');
        const proteinValue = document.getElementById('proteinValue');
        const verifiedBadge = document.getElementById('verifiedBadge');
        const voiceSearchBtn = document.getElementById('voiceSearchBtn');

        const fallbackData = {
            "apple": { calories: 52, protein: 0.3 },
            "banana": { calories: 89, protein: 1.1 },
            "egg": { calories: 155, protein: 13 },
            "chicken breast": { calories: 165, protein: 31 },
            "broccoli": { calories: 34, protein: 2.8 },
            "spinach": { calories: 23, protein: 2.9 },
            "salmon": { calories: 208, protein: 20 },
            "avocado": { calories: 160, protein: 2 },
            "brown rice": { calories: 111, protein: 2.6 },
            "almonds": { calories: 579, protein: 21 },
        };

        const debounce = (func, delay) => {
            let timeoutId;
            return (...args) => {
                clearTimeout(timeoutId);
                timeoutId = setTimeout(() => {
                    func.apply(this, args);
                }, delay);
            };
        };

        const handleSearch = async () => {
            const query = searchInput.value.toLowerCase();
            const portion = parseFloat(portionInput.value) || 1; // Default to 1 portion if empty

            if (!query) {
                resultsCard.classList.remove('visible');
                return;
            }

            pulseAnimation.style.display = 'block';
            resultsCard.classList.remove('visible');
            verifiedBadge.style.display = 'none';

            try {
                // We'll treat the portion as a multiplier for the base 100g data
                const response = await fetch(`https://world.openfoodfacts.org/cgi/search.pl?search_terms=${query}&json=1`);
                const data = await response.json();

                if (data.products && data.products.length > 0) {
                    const product = data.products[0];
                    const calories_100g = product.nutriments['energy-kcal_100g'] || 0;
                    const protein_100g = product.nutriments.proteins_100g || 0;
                    
                    const finalCalories = (calories_100g * portion).toFixed(0);
                    const finalProtein = (protein_100g * portion).toFixed(1);

                    updateResults(query, finalCalories, finalProtein, true);
                    return;
                }

                const fallback = findFallback(query);
                if (fallback) {
                    const finalCalories = (fallback.calories * portion).toFixed(0);
                    const finalProtein = (fallback.protein * portion).toFixed(1);
                    updateResults(query, finalCalories, finalProtein, false);
                    return;
                }
                
                showNotFound(query);

            } catch (error) {
                console.error("Error fetching nutrition data:", error);
                pulseAnimation.textContent = 'Sorry, something went wrong.';
            } finally {
                pulseAnimation.style.display = 'none';
            }
        };

        const findFallback = (query) => {
            const queryWords = query.split(' ');
            for (const key in fallbackData) {
                if (queryWords.some(word => key.includes(word))) {
                    return fallbackData[key];
                }
            }
            return null;
        };

        const updateResults = (query, calories, protein, isVerified) => {
            const portionValue = portionInput.value || "1";
            foodQuery.textContent = `${portionValue} portion(s) of ${query}`;
            caloriesValue.textContent = calories;
            proteinValue.textContent = protein;
            verifiedBadge.style.display = isVerified ? 'block' : 'none';
            resultsCard.classList.add('visible');
        };
        
        const showNotFound = (query) => {
            foodQuery.textContent = `No results for \"${query}\"`;
            caloriesValue.textContent = '--';
            proteinValue.textContent = '--';
            verifiedBadge.style.display = 'none';
            resultsCard.classList.add('visible');
        };

        const debouncedSearch = debounce(handleSearch, 500);

        searchInput.addEventListener('input', debouncedSearch);
        portionInput.addEventListener('input', debouncedSearch);

        // Voice Search
        const SpeechRecognition = window.SpeechRecognition || window.webkitSpeechRecognition;
        if (SpeechRecognition) {
            const recognition = new SpeechRecognition();
            recognition.continuous = false;
            recognition.lang = 'en-US';
            recognition.interimResults = false;
            recognition.maxAlternatives = 1;

            voiceSearchBtn.addEventListener('click', () => {
                recognition.start();
                voiceSearchBtn.textContent = 'üéôÔ∏è';
            });

            recognition.onresult = (event) => {
                const speechResult = event.results[0][0].transcript;
                searchInput.value = speechResult;
                debouncedSearch();
            };

            recognition.onspeechend = () => {
                recognition.stop();
                voiceSearchBtn.textContent = 'üé§';
            };

            recognition.onerror = (event) => {
                console.error('Speech recognition error:', event.error);
                voiceSearchBtn.textContent = 'üé§';
            };
        } else {
            voiceSearchBtn.style.display = 'none';
            console.log('Speech recognition not supported in this browser.');
        }

    </script>

</body>
</html>
